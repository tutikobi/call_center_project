<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Sistema Call Center{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css'  ) }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <h5 class="sidebar-title">{{ current_user.empresa.nome_empresa }}</h5>
        <nav class="nav flex-column">
            
            <a class="nav-link {% if request.endpoint == 'routes.dashboard' or request.endpoint == 'admin.dashboard' %}active{% endif %}" 
               href="{{ url_for('admin.dashboard') if current_user.role == 'super_admin' else url_for('routes.dashboard') }}">
                <i class="fas fa-tachometer-alt fa-fw me-2"></i> Dashboard
            </a>

            {% if current_user.role != 'super_admin' %}
                <a class="nav-link {% if request.endpoint == 'routes.conversas' %}active{% endif %}" href="{{ url_for('routes.conversas') }}">
                    <i class="fas fa-comments fa-fw me-2"></i> Conversas WhatsApp
                </a>
                <a class="nav-link {% if request.endpoint == 'routes.avaliar' %}active{% endif %}" href="{{ url_for('routes.avaliar') }}">
                    <i class="fas fa-star fa-fw me-2"></i> Avaliação
                </a>
                <a class="nav-link {% if request.endpoint == 'routes.relatorios' %}active{% endif %}" href="{{ url_for('routes.relatorios' ) }}">
                    <i class="fas fa-chart-bar fa-fw me-2"></i> Relatórios
                </a>
            {% endif %}
            
            {% if current_user.role == 'admin_empresa' %}
                <hr class="sidebar-divider">
                <a class="nav-link {% if request.endpoint.startswith('management.') and 'configuracoes' not in request.endpoint %}active{% endif %}" href="{{ url_for('management.listar_usuarios') }}">
                    <i class="fas fa-users-cog fa-fw me-2"></i> Gerenciar Usuários
                </a>
                <a class="nav-link {% if request.endpoint == 'management.configuracoes' %}active{% endif %}" href="{{ url_for('management.configuracoes') }}">
                    <i class="fas fa-cogs fa-fw me-2"></i> Configurações
                </a>
            {% endif %}

            {% if current_user.role == 'super_admin' %}
                <hr class="sidebar-divider">
                <a class="nav-link {% if request.endpoint == 'admin.index' %}active{% endif %}" href="{{ url_for('admin.index') }}">
                    <i class="fas fa-building fa-fw me-2"></i> Gerenciar Empresas
                </a>
                <a class="nav-link {% if 'relatorio_empresas' in request.endpoint %}active{% endif %}" href="{{ url_for('admin.relatorio_empresas') }}">
                    <i class="fas fa-file-alt fa-fw me-2"></i> Relatório de Empresas
                </a>
                <a class="nav-link {% if request.endpoint.startswith('admin.') and 'tickets' in request.endpoint %}active{% endif %}" href="{{ url_for('admin.listar_tickets') }}">
                    <i class="fas fa-life-ring fa-fw me-2"></i> Tickets de Suporte
                </a>
            {% endif %}
        </nav>
        <div class="sidebar-footer">
            <a href="{{ url_for('auth.logout') }}" class="nav-link">
                <i class="fas fa-sign-out-alt fa-fw me-2"></i> Logout
            </a>
        </div>
    </div>

    <main class="content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    {% if current_user.is_authenticated and current_user.role != 'super_admin' %}
    <button class="btn btn-primary btn-lg rounded-circle shadow" id="support-fab" data-bs-toggle="modal" data-bs-target="#supportModal" title="Abrir Suporte">
        <i class="fas fa-question"></i>
    </button>
    <div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supportModalLabel">Abrir um Ticket de Suporte</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('management.novo_ticket') }}" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="assunto" class="form-label">Assunto</label>
                            <select class="form-select" id="assunto" name="assunto" required>
                                <option value="" disabled selected>Selecione o motivo do contato...</option>
                                <option value="Suporte Técnico">Suporte Técnico</option>
                                <option value="Problema em Relatórios">Problema em Relatórios</option>
                                <option value="Emissão de Fatura">Emissão de Fatura</option>
                                <option value="Tirar Dúvidas">Tirar Dúvidas</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="5" required placeholder="Por favor, descreva sua solicitação com o máximo de detalhes possível."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar Ticket</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>