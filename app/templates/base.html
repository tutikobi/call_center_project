<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Sistema Call Center{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css'  ) }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <h5 class="sidebar-title">{{ current_user.empresa.nome_empresa }}</h5>
        <nav class="nav flex-column">
            <a class="nav-link {% if request.endpoint == 'routes.dashboard' or request.endpoint == 'admin.dashboard' %}active{% endif %}"
               href="{{ url_for('admin.dashboard') if current_user.role == 'super_admin' else url_for('routes.dashboard') }}">
                <i class="fas fa-tachometer-alt fa-fw me-2"></i> Dashboard
            </a>
            {% if current_user.role != 'super_admin' %}
                <a class="nav-link {% if request.endpoint == 'routes.conversas' %}active{% endif %}" href="{{ url_for('routes.conversas') }}">
                    <i class="fas fa-comments fa-fw me-2"></i> Conversas WhatsApp
                </a>
                <a class="nav-link {% if request.endpoint == 'routes.emails' or request.endpoint == 'routes.caixa_email_agente' %}active{% endif %}" href="{{ url_for('routes.emails') }}">
                    <i class="fas fa-envelope fa-fw me-2"></i> Emails
                </a>
                <a class="nav-link {% if request.endpoint == 'routes.avaliar' %}active{% endif %}" href="{{ url_for('routes.avaliar') }}">
                    <i class="fas fa-star fa-fw me-2"></i> Avaliação
                </a>
                <a class="nav-link {% if request.endpoint == 'routes.relatorios' %}active{% endif %}" href="{{ url_for('routes.relatorios' ) }}">
                    <i class="fas fa-chart-bar fa-fw me-2"></i> Relatórios
                </a>
            {% endif %}

            {% if current_user.is_authenticated and current_user.empresa and current_user.empresa.plano in ['medio', 'completo', 'customizado'] and current_user.empresa.plano_rh %}
                <hr class="sidebar-divider">
                <a class="nav-link {% if request.endpoint.startswith('rh.') %}active{% endif %}" href="{{ url_for('rh.dashboard') }}">
                    <i class="fas fa-users-cog fa-fw me-2"></i> RH
                </a>
            {% endif %}
            {% if current_user.role == 'admin_empresa' %}
                <hr class="sidebar-divider">
                <a class="nav-link {% if request.endpoint.startswith('management.') and 'configuracoes' not in request.endpoint %}active{% endif %}" href="{{ url_for('management.listar_usuarios') }}">
                    <i class="fas fa-users-cog fa-fw me-2"></i> Gerenciar Usuários
                </a>
                <a class="nav-link {% if request.endpoint == 'management.configuracoes' %}active{% endif %}" href="{{ url_for('management.configuracoes') }}">
                    <i class="fas fa-cogs fa-fw me-2"></i> Configurações
                </a>
            {% endif %}

            {% if current_user.role == 'super_admin' %}
                <hr class="sidebar-divider">
                <a class="nav-link {% if request.endpoint == 'admin.index' %}active{% endif %}" href="{{ url_for('admin.index') }}">
                    <i class="fas fa-building fa-fw me-2"></i> Gerenciar Empresas
                </a>
                <a class="nav-link {% if request.endpoint.startswith('admin.') and ('historico' in request.endpoint or 'detalhes' in request.endpoint) %}active{% endif %}" href="{{ url_for('admin.historico_empresas') }}">
                    <i class="fas fa-history fa-fw me-2"></i> Histórico e Infos
                </a>
                <a class="nav-link {% if 'relatorio_empresas' in request.endpoint %}active{% endif %}" href="{{ url_for('admin.relatorio_empresas') }}">
                    <i class="fas fa-file-alt fa-fw me-2"></i> Relatório de Empresas
                </a>
                <a class="nav-link {% if request.endpoint.startswith('admin.') and 'tickets' in request.endpoint %}active{% endif %}" href="{{ url_for('admin.listar_tickets') }}">
                    <i class="fas fa-life-ring fa-fw me-2"></i> Tickets de Suporte
                </a>
                <a class="nav-link {% if request.endpoint == 'admin.treinamento_ia' %}active{% endif %}" href="{{ url_for('admin.treinamento_ia') }}">
                    <i class="fas fa-brain fa-fw me-2"></i> Treinamento da I.A.
                </a>
            {% endif %}
        </nav>
        <div class="sidebar-footer">
            <a href="{{ url_for('auth.logout') }}" class="nav-link">
                <i class="fas fa-sign-out-alt fa-fw me-2"></i> Logout
            </a>
        </div>
    </div>

    <div class="main-wrapper">
        <main class="content">
            <div class="topbar">
                <div class="topbar-content">
                    <div class="flex-grow-1"></div>
                    <ul class="navbar-nav flex-row">
                        {% if current_user.is_authenticated and current_user.role != 'super_admin' %}
                        <li class="nav-item dropdown">
                            <a class="nav-link" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bell fa-lg"></i>
                                <span class="badge rounded-pill bg-danger" id="notification-count" style="position: absolute; top: 0; right: -5px; display: none;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" id="notification-dropdown" aria-labelledby="navbarDropdown">
                                <li><h6 class="dropdown-header">Notificações</h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <div id="notification-list">
                                    <li><a class="dropdown-item text-muted" href="#">Nenhuma nova notificação</a></li>
                                </div>
                            </ul>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% block content %}{% endblock %}
        </main>

        <footer class="footer">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8 text-center text-md-start">
                        <h6 class="text-uppercase fw-bold mb-2">Contato</h6>
                        <p class="mb-0 small">Tel: (51) 99529-1823 | ti@pluggedtech.com.br</p>
                        <p class="mb-0 small">Porto Alegre - RS, Brasil</p>
                    </div>
                    <div class="col-md-4 text-center text-md-end mt-3 mt-md-0">
                        <p class="mb-0 small">© 2025 Desenvolvido por Plugged Tecnologia.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Alerta de Prioridade</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body-message"></div>
      </div>
    </div>

    {% if current_user.is_authenticated and current_user.role != 'super_admin' %}
    <button class="btn btn-primary btn-lg rounded-circle shadow" id="support-fab" data-bs-toggle="modal" data-bs-target="#supportModal" title="Abrir Suporte">
        <i class="fas fa-question"></i>
    </button>
    <div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supportModalLabel">Assistente de Suporte</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="support-chat-body" style="height: 400px; display: flex; flex-direction: column;">
                    <div id="chat-messages" class="flex-grow-1" style="overflow-y: auto; padding: 10px;">
                        </div>
                    <div id="resolution-buttons" class="text-center my-2 d-none">
                        <p>A sua dúvida foi resolvida?</p>
                        <button class="btn btn-success" id="btn-resolved">Sim, foi resolvida!</button>
                        <button class="btn btn-danger" id="btn-not-resolved">Não, preciso de mais ajuda.</button>
                    </div>
                    <div class="input-group mt-auto">
                        <input type="text" id="chat-input" class="form-control" placeholder="Digite uma opção...">
                        <button class="btn btn-primary" id="send-chat-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}

    {% if current_user.is_authenticated and current_user.role != 'super_admin' %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const supportModal = document.getElementById('supportModal');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-chat-btn');
            const resolutionButtons = document.getElementById('resolution-buttons');
            let chatState = 'awaiting_option';
            let selectedTopic = '';
            let problemDescription = '';
            const initialBotMessage = `Olá! Sou seu assistente de suporte. Como posso ajudar hoje?<br><br>
                                <b>1</b> - Suporte Técnico<br>
                                <b>2</b> - Problemas com Fatura<br>
                                <b>3</b> - Tirar Dúvidas<br>
                                <b>4</b> - Problemas no Dashboard<br>
                                <b>5</b> - Problemas no WhatsApp ou Email`;
            const topics = { '1': 'Suporte Técnico', '2': 'Problemas com Fatura', '3': 'Tirar Dúvidas', '4': 'Problemas no Dashboard', '5': 'Problemas no WhatsApp ou Email' };
            
            function resetChat() {
                chatState = 'awaiting_option';
                selectedTopic = '';
                problemDescription = '';
                chatMessages.innerHTML = ''; 
                addMessage(initialBotMessage, 'bot');
                resolutionButtons.classList.add('d-none'); 
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = 'Digite uma opção...';
                chatInput.value = '';
            }
            
            supportModal.addEventListener('show.bs.modal', resetChat);

            function addMessage(content, sender) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('chat-message-wrapper');

                if (sender === 'user') {
                    wrapper.classList.add('user-message');
                    wrapper.innerHTML = `<div class="chat-bubble">${content}</div>`;
                } else {
                    wrapper.classList.add('bot-message');
                    wrapper.innerHTML = `
                        <img src="{{ url_for('static', filename='images/bot_avatar.jpg') }}" alt="Bot Avatar" class="chat-avatar">
                        <div class="chat-bubble">
                            <strong class="d-block chat-sender-name">Arthur</strong>
                            ${content}
                        </div>
                    `;
                }
                chatMessages.appendChild(wrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function createTicketFromChat() {
                resolutionButtons.classList.add('d-none');
                chatInput.disabled = true;
                sendBtn.disabled = true;
                try {
                    const response = await fetch("{{ url_for('management.auto_create_ticket') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            topic: selectedTopic,
                            description: problemDescription
                        })
                    });
                    const result = await response.json();
                    if (result.status === 'ok') {
                        addMessage('Ticket criado com sucesso! Nossa equipe entrará em contato em breve. Você já pode fechar esta janela.', 'bot');
                    } else { throw new Error(result.message); }
                } catch (error) {
                    addMessage('Ocorreu um erro ao criar o ticket. Por favor, feche e tente novamente.', 'bot');
                }
            }

            async function handleUserInput() {
                const userInput = chatInput.value.trim();
                if (!userInput) return;
                addMessage(userInput, 'user');
                chatInput.value = '';
                if (chatState === 'awaiting_option') {
                    if (topics[userInput]) {
                        selectedTopic = topics[userInput];
                        chatState = 'awaiting_description';
                        setTimeout(() => {
                            let botMessage = 'Muito bem. <br>Agora, ';
                            if (selectedTopic === 'Tirar Dúvidas') {
                                botMessage += 'qual é a sua dúvida?';
                            } else {
                                botMessage += 'pode descrever com mais detalhes o seu problema?';
                            }
                            addMessage(botMessage, 'bot');
                            chatInput.placeholder = 'Descreva sua dúvida ou problema...';
                        }, 500);
                    } else {
                        setTimeout(() => { addMessage('Opção inválida. Por favor, digite um número de 1 a 5.', 'bot'); }, 500);
                    }
                } else if (chatState === 'awaiting_description') {
                    problemDescription = userInput; 
                    chatState = 'solving';
                    addMessage('Obrigado. Consultando minha base de conhecimento...', 'bot');
                    chatInput.placeholder = 'Aguarde...';
                    chatInput.disabled = true;
                    sendBtn.disabled = true;
                    try {
                        const response = await fetch("{{ url_for('management.sugestao_ia') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ descricao: problemDescription })
                        });
                        const data = await response.json();
                        setTimeout(() => {
                            addMessage(data.sugestao, 'bot');
                            if (data.status === 'found') {
                                resolutionButtons.classList.remove('d-none');
                            } else {
                                createTicketFromChat();
                            }
                        }, 1000);
                    } catch (error) {
                        addMessage('Desculpe, ocorreu um erro ao contatar a IA. Um ticket será criado para si.', 'bot');
                        createTicketFromChat();
                    }
                }
            }
            
            sendBtn.addEventListener('click', handleUserInput);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUserInput(); });
            
            document.getElementById('btn-resolved').addEventListener('click', () => {
                addMessage('Fico feliz em ajudar! Encerrando o chat.', 'bot');
                resolutionButtons.classList.add('d-none');
                chatInput.disabled = true;
            });
            
            document.getElementById('btn-not-resolved').addEventListener('click', createTicketFromChat);
        });
    </script>
    {% endif %}
</body>
</html>