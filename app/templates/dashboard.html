{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
{% if current_user.role in ['agente', 'admin_empresa'] %}
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>Monitore sua produtividade! Vincule o agente de desktop para começar.</span>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linkAgentModal">
        <i class="fas fa-link me-2"></i>Vincular Agente de Desktop
    </button>
</div>
{% endif %}

<h1 class="h2 mb-4">Dashboard Unificado - Chamadas & WhatsApp</h1>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-icon bg-info"><i class="fas fa-star"></i></div>
            <div class="metric-content">
                <div class="metric-value">{{ total_avaliacoes or 0 }}</div>
                <div class="metric-label">Avaliações</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-icon bg-success"><i class="fab fa-whatsapp"></i></div>
            <div class="metric-content">
                <div class="metric-value">{{ conversas_ativas or 0 }}</div>
                <div class="metric-label">Conversas Ativas</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-icon bg-warning"><i class="fas fa-clock"></i></div>
            <div class="metric-content">
                <div class="metric-value">N/A</div>
                <div class="metric-label">T.M. Resposta</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-icon bg-danger"><i class="fas fa-smile"></i></div>
            <div class="metric-content">
                <div class="metric-value">{{ csat_geral or 'N/A' }}</div>
                <div class="metric-label">CSAT Médio</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">Atendimentos por Canal</div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="graficoCanais"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">CSAT Médio por Agente</div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="graficoCsatAgente"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        <h3 class="h4">Agentes da Empresa</h3>
        <div class="row">
            {% for agente in agentes_online %}
            <div class="col-lg-4 col-md-6 mb-3">
                <a href="{{ url_for('routes.dashboard_agente', agente_id=agente.id) }}" class="agent-card-link">
                    <div class="agent-card">
                        <div class="agent-avatar">{{ agente.nome[0] | upper }}</div>
                        <div class="agent-info">
                            <div class="agent-name">{{ agente.nome }}</div>
                            <div class="agent-status text-muted">
                                {% if agente.role == 'admin_empresa' %}
                                    Admin da Empresa
                                {% else %}
                                    Agente
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% else %}
            <p class="text-muted">Nenhum agente encontrado.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="linkAgentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vincular Agente de Desktop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="initial-step">
                    <p>Para começar o monitoramento, clique no botão abaixo para gerar um token de vínculo.</p>
                    <div class="text-center">
                        <button class="btn btn-success" id="generate-token-btn">Gerar Token de Vínculo</button>
                    </div>
                </div>

                <div id="token-step" style="display: none;">
                    <p>Token gerado! Agora, clique no botão abaixo para abrir e vincular o agente de monitoramento.</p>
                    <div class="text-center my-3">
                        <a href="#" id="link-agent-btn" class="btn btn-primary btn-lg">
                            <i class="fas fa-rocket me-2"></i> Abrir e Vincular Agente
                        </a>
                    </div>
                    <hr>
                    <p class="text-muted small">
                        <strong>Primeira vez aqui?</strong> Se o botão acima não funcionar, significa que o programa de monitoramento não está instalado.
                        <a href="#">Faça o download do instalador aqui</a> e execute-o. Depois, tente novamente.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Script do Dashboard (Gráficos) ---
document.addEventListener('DOMContentLoaded', function () {
    const renderChart = (ctx, type, labels, data, chartLabel) => {
        // ... (código do gráfico, sem alteração) ...
        const canvas = ctx.canvas;
        if (!data || data.length === 0) {
            canvas.parentElement.innerHTML = '<p class="text-center text-muted mt-5 pt-5">Não há dados para exibir este gráfico.</p>';
            return;
        }
        const chartColors = ['#27ae60', '#2980b9', '#f1c40f', '#e74c3c', '#8e44ad'];
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: chartLabel,
                    data: data,
                    backgroundColor: chartColors,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type === 'pie',
                        position: 'bottom',
                    }
                },
                scales: {
                    y: { beginAtZero: true, display: type === 'bar' },
                    x: { display: type === 'bar' }
                }
            }
        });
    };

    fetch("{{ url_for('api.dados_dashboard_graficos') }}")
        .then(response => response.json())
        .then(data => {
            const ctxCanais = document.getElementById('graficoCanais');
            if (ctxCanais && data.graficoCanais) {
                renderChart(ctxCanais.getContext('2d'), 'pie', data.graficoCanais.labels, data.graficoCanais.data, 'Atendimentos');
            }
            const ctxCsatAgente = document.getElementById('graficoCsatAgente');
            if (ctxCsatAgente && data.graficoCsatAgente) {
                renderChart(ctxCsatAgente.getContext('2d'), 'bar', data.graficoCsatAgente.labels, data.graficoCsatAgente.data, 'CSAT Médio');
            }
        });

    // --- Lógica para o Modal de Vínculo ---
    const generateBtn = document.getElementById('generate-token-btn');
    const initialStep = document.getElementById('initial-step');
    const tokenStep = document.getElementById('token-step');
    const linkAgentBtn = document.getElementById('link-agent-btn');

    generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gerando...';

        try {
            const response = await fetch("{{ url_for('routes.generate_desktop_token') }}", { method: 'POST' });
            const data = await response.json();

            if (data.status === 'success') {
                // Monta o link com o protocolo personalizado
                linkAgentBtn.href = `callcenteragent:?token=${data.token}`;
                initialStep.style.display = 'none';
                tokenStep.style.display = 'block';
            } else {
                alert('Erro ao gerar token: ' + data.message);
            }
        } catch (error) {
            alert('Erro de conexão ao gerar o token.');
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'Gerar Token de Vínculo';
        }
    });

    const linkAgentModal = document.getElementById('linkAgentModal');
    linkAgentModal.addEventListener('hidden.bs.modal', () => {
        initialStep.style.display = 'block';
        tokenStep.style.display = 'none';
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Gerar Token de Vínculo';
        linkAgentBtn.href = '#';
    });
});
</script>
{% endblock %}