{% extends "base.html" %}

{% block title %}Conversas WhatsApp{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Coluna da Lista de Conversas -->
        <div class="col-md-4 h-100 p-0" id="lista-conversas-coluna">
            <div class="card h-100 rounded-0 border-end">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Conversas Ativas ({{ conversas|length }})</h5>
                </div>
                <div class="card-body p-0 overflow-auto">
                    <div class="list-group list-group-flush" id="lista-de-conversas">
                        {% for conversa in conversas %}
                        <a href="#" class="list-group-item list-group-item-action" id="conversa-item-{{ conversa.id }}" data-conversa-id="{{ conversa.id }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ conversa.nome_cliente }}</h6>
                                <small class="text-muted">{{ conversa.inicio.strftime('%H:%M') }}</small>
                            </div>
                            <!-- CORREÇÃO APLICADA: Lógica complexa removida para evitar erros de renderização -->
                            <p class="mb-1 small text-muted" id="ultima-msg-{{ conversa.id }}">
                                Clique para ver as mensagens...
                            </p>
                        </a>
                        {% else %}
                        <div class="p-3 text-center text-muted">Nenhuma conversa ativa.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna da Janela de Chat -->
        <div class="col-md-8 h-100 p-0" id="chat-coluna">
            <div class="card h-100 rounded-0 d-flex flex-column">
                <div class="card-header bg-light" id="chat-header">
                    <h5 class="mb-0">Selecione uma conversa</h5>
                </div>
                <div class="card-body overflow-auto" id="chat-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <i class="fas fa-comments fa-3x"></i>
                        <p class="mt-2">As mensagens da conversa selecionada aparecerão aqui.</p>
                    </div>
                </div>
                <div class="card-footer bg-light p-3" id="chat-footer" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="mensagem-input" class="form-control" placeholder="Digite sua mensagem...">
                        <button class="btn btn-success" type="button" id="enviar-btn">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bloco de Script Robusto -->
<script>
    let conversaAtivaId = null;

    function carregarConversa(id, elementoClicado) {
        conversaAtivaId = id;

        document.querySelectorAll('#lista-de-conversas .list-group-item').forEach(el => {
            el.classList.remove('active');
        });
        elementoClicado.classList.add('active');

        fetch(`/api/conversa/${id}`)
            .then(response => {
                if (!response.ok) { throw new Error('Falha na rede ou rota não encontrada.'); }
                return response.json();
            })
            .then(data => {
                const chatHeader = document.getElementById('chat-header');
                chatHeader.innerHTML = `<h5 class="mb-0">${data.nome_cliente}</h5><small class="text-muted">Status: ${data.status}</small>`;

                const chatBody = document.getElementById('chat-body');
                chatBody.innerHTML = '';
                data.mensagens.forEach(msg => {
                    const direcao = msg.remetente === 'agente' ? 'mensagem-agente' : 'mensagem-cliente';
                    const balao = `
                        <div class="d-flex ${direcao === 'mensagem-agente' ? 'justify-content-end' : 'justify-content-start'} mb-3">
                            <div class="balao-mensagem ${direcao}">
                                <div>${msg.conteudo}</div>
                                <div class="timestamp">${msg.timestamp}</div>
                            </div>
                        </div>
                    `;
                    chatBody.innerHTML += balao;
                });
                chatBody.scrollTop = chatBody.scrollHeight;

                document.getElementById('chat-footer').style.display = 'block';
            })
            .catch(error => {
                console.error('Erro ao carregar a conversa:', error);
                const chatHeader = document.getElementById('chat-header');
                const chatBody = document.getElementById('chat-body');
                chatHeader.innerHTML = `<h5 class="mb-0 text-danger">Erro</h5>`;
                chatBody.innerHTML = `<div class="alert alert-danger m-3">Não foi possível carregar a conversa. Verifique o console para mais detalhes.</div>`;
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        try {
            const listaConversas = document.getElementById('lista-de-conversas');
            if (!listaConversas) {
                console.error("Elemento #lista-de-conversas não encontrado.");
                return;
            }

            listaConversas.addEventListener('click', function(event) {
                event.preventDefault();
                const clickedItem = event.target.closest('.list-group-item');
                if (clickedItem) {
                    const conversaId = clickedItem.dataset.conversaId;
                    if (conversaId) {
                        carregarConversa(parseInt(conversaId), clickedItem);
                    }
                }
            });
        } catch (e) {
            console.error("Ocorreu um erro ao inicializar a página de conversas:", e);
        }
    });
</script>
{% endblock %}
