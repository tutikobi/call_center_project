{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">{{ page_title }}</h1>
    <div>
        <small class="text-muted">Status em tempo real</small>
    </div>
</div>

<div class="row" id="agents-grid">
    {% for agent in agents %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100 agent-monitor-card" id="agent-card-{{ agent.id }}" data-agent-id="{{ agent.id }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">{{ agent.nome }}</h6>
                <span class="badge bg-secondary" id="agent-status-{{ agent.id }}">Offline</span>
            </div>
            <div class="card-body">
                <p class="text-muted mb-2">
                    <i class="fas fa-clock me-2"></i>Inativo há: 
                    <strong id="agent-inactive-time-{{ agent.id }}">00:00:00</strong>
                </p>
                <p class="mb-1">
                    <i class="fas fa-window-maximize me-2"></i>
                    <strong class="d-block">Atividade Atual:</strong>
                    <span id="agent-activity-{{ agent.id }}" class="text-truncate d-block">Nenhuma atividade registrada.</span>
                </p>
                <p class="mb-1">
                    <i class="fas fa-cogs me-2"></i>
                    <strong class="d-block">Software/Site:</strong>
                    <span id="agent-process-{{ agent.id }}">N/A</span>
                </p>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <span class="badge" id="agent-category-{{ agent.id }}">Não Classificado</span>
                <a href="{{ url_for('routes.productivity_agent_log', agente_id=agent.id) }}" class="btn btn-sm btn-outline-primary">
                    Ver Histórico
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <p class="text-muted" id="no-agents-message">Nenhum agente para monitorar.</p>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    const agentsData = {};
    const agentsGrid = document.getElementById('agents-grid');

    // --- FUNÇÃO PARA ADICIONAR UM NOVO CARD DE AGENTE ---
    function addAgentCard(agent) {
        // Remove a mensagem "Nenhum agente" se ela existir
        const noAgentsMessage = document.getElementById('no-agents-message');
        if (noAgentsMessage) {
            noAgentsMessage.remove();
        }

        // Cria o HTML para o novo card
        const cardHtml = `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 agent-monitor-card" id="agent-card-${agent.id}" data-agent-id="${agent.id}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${agent.nome}</h6>
                    <span class="badge bg-secondary" id="agent-status-${agent.id}">Offline</span>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">
                        <i class="fas fa-clock me-2"></i>Inativo há: 
                        <strong id="agent-inactive-time-${agent.id}">00:00:00</strong>
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-window-maximize me-2"></i>
                        <strong class="d-block">Atividade Atual:</strong>
                        <span id="agent-activity-${agent.id}" class="text-truncate d-block">Nenhuma atividade registrada.</span>
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-cogs me-2"></i>
                        <strong class="d-block">Software/Site:</strong>
                        <span id="agent-process-${agent.id}">N/A</span>
                    </p>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <span class="badge" id="agent-category-${agent.id}">Não Classificado</span>
                    <a href="/productivity/agent/${agent.id}/log" class="btn btn-sm btn-outline-primary">
                        Ver Histórico
                    </a>
                </div>
            </div>
        </div>
        `;
        agentsGrid.insertAdjacentHTML('beforeend', cardHtml);

        // Inicializa os dados para o novo agente
        agentsData[agent.id] = {
            lastUpdate: null,
            inactiveSince: new Date(),
            isInactive: true
        };
    }

    // Inicializa os dados para cada agente no carregamento da página
    document.querySelectorAll('.agent-monitor-card').forEach(card => {
        const agentId = card.dataset.agentId;
        agentsData[agentId] = {
            lastUpdate: null,
            inactiveSince: new Date(),
            isInactive: true
        };
    });

    // Um único timer global que atualiza a cada segundo
    setInterval(() => {
        const now = new Date();
        for (const agentId in agentsData) {
            if (agentsData[agentId].isInactive) {
                const diff = Math.floor((now - agentsData[agentId].inactiveSince) / 1000);
                const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                const timeEl = document.getElementById(`agent-inactive-time-${agentId}`);
                if (timeEl) {
                    timeEl.textContent = `${h}:${m}:${s}`;
                }
            }
        }
    }, 1000);

    socket.on('connect', function() {
        console.log('Conectado ao servidor de WebSocket.');
    });

    // --- OUVINTE PARA O NOVO EVENTO ---
    socket.on('new_agent_added', function(data) {
        console.log('Novo agente adicionado:', data);
        addAgentCard(data);
    });

    socket.on('productivity_update', function(data) {
        const agentId = data.usuario_id;
        if (!agentsData[agentId]) return;

        const agent = agentsData[agentId];
        agent.lastUpdate = new Date();

        if (agent.isInactive) {
            agent.isInactive = false;
            document.getElementById(`agent-inactive-time-${agentId}`).textContent = '00:00:00';
            const statusEl = document.getElementById(`agent-status-${agentId}`);
            statusEl.textContent = 'Ativo';
            statusEl.className = 'badge bg-success';
        }

        document.getElementById(`agent-activity-${agentId}`).textContent = data.url || data.window_title || 'N/A';
        document.getElementById(`agent-process-${agentId}`).textContent = data.process_name || 'N/A';
        
        const categoryEl = document.getElementById(`agent-category-${agentId}`);
        categoryEl.textContent = data.category || 'Não Classificado';
        
        let categoryClass = 'bg-secondary';
        if (data.is_productive === true) categoryClass = 'bg-primary';
        else if (data.is_productive === false) categoryClass = 'bg-danger';
        categoryEl.className = `badge ${categoryClass}`;

        clearTimeout(agent.inactiveTimeout);
        agent.inactiveTimeout = setTimeout(() => {
            agent.isInactive = true;
            agent.inactiveSince = new Date();
            const statusEl = document.getElementById(`agent-status-${agentId}`);
            statusEl.textContent = 'Inativo';
            statusEl.className = 'badge bg-warning text-dark';
        }, 30 * 1000);
    });
});
</script>
{% endblock %}