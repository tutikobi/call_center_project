{% extends "base.html" %}

{% block title %}Relatórios{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Relatórios</h1>
    <!-- O botão só aparece se houver dados na tabela -->
    {% if dados_relatorio %}
    <button id="btnGerarPdf" class="btn btn-primary">
        <i class="fas fa-print me-2"></i> Gerar PDF / Imprimir
    </button>
    {% endif %}
</div>

<!-- Card de Filtros -->
<div class="card mb-4">
    <div class="card-header">
        Filtros de Relatório
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('routes.relatorios') }}">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="periodo" class="form-label">Período</label>
                    <select id="periodo" name="periodo" class="form-select">
                        <option value="7d" {% if filtros.periodo == '7d' %}selected{% endif %}>Últimos 7 dias</option>
                        <option value="30d" {% if filtros.periodo == '30d' %}selected{% endif %}>Últimos 30 dias</option>
                        <option value="todos" {% if filtros.periodo == 'todos' %}selected{% endif %}>Todo o período</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="canal" class="form-label">Canal</label>
                    <select id="canal" name="canal" class="form-select">
                        <option value="todos" {% if filtros.canal == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="whatsapp" {% if filtros.canal == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
                        <option value="voz" {% if filtros.canal == 'voz' %}selected{% endif %}>Voz</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="agente" class="form-label">Agente</label>
                    <select id="agente" name="agente" class="form-select">
                        <option value="todos">Todos</option>
                        {% for agente in agentes %}
                        <option value="{{ agente.id }}" {% if filtros.agente == agente.id|string %}selected{% endif %}>{{ agente.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-filter me-2"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Card do Relatório (área que será impressa) -->
<div class="card" id="areaRelatorio">
    <div class="card-header">
        Resultados do Relatório
    </div>
    <div class="card-body">
        {% if request.method == 'POST' %}
            {% if dados_relatorio %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Agente</th>
                            <th>Canal</th>
                            <th>CSAT</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for avaliacao in dados_relatorio %}
                        <tr>
                            <td>{{ avaliacao.data.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ avaliacao.agente }}</td>
                            <td>
                                {% if avaliacao.canal == 'whatsapp' %}
                                    <span class="badge bg-success">WhatsApp</span>
                                {% else %}
                                    <span class="badge bg-primary">Voz</span>
                                {% endif %}
                            </td>
                            <td>{{ avaliacao.csat }}</td>
                            <td>{{ avaliacao.observacoes }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">Nenhum dado encontrado para os filtros selecionados.</div>
            {% endif %}
        {% else %}
        <div class="alert alert-secondary">Aplique os filtros acima para gerar um relatório.</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Adiciona a biblioteca jsPDF e html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function( ) {
    const btnGerarPdf = document.getElementById('btnGerarPdf');
    
    if (btnGerarPdf) {
        btnGerarPdf.addEventListener('click', function() {
            // Pega a área do relatório que queremos transformar em PDF
            const areaRelatorio = document.getElementById('areaRelatorio');
            
            // Usa html2canvas para tirar um "print" da div e transformar em uma imagem
            html2canvas(areaRelatorio).then(canvas => {
                // Cria um novo documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // p=portrait, mm=milímetros, a4=tamanho da folha
                
                // Pega as dimensões da imagem e do PDF para calcular o tamanho correto
                const imgData = canvas.toDataURL('image/png');
                const imgProps= doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                // Adiciona a imagem ao PDF
                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                // Salva o PDF com um nome de arquivo
                doc.save('relatorio-call-center.pdf');
            });
        });
    }
});
</script>
{% endblock %}
